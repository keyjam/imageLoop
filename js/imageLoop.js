(function($,undefined){$.key=$.key||{};$.key.logFlag=false;$.key.isDebug=false;/*BannerBasedir*/$.key.imageBaseDir = 'img/banner/';/*BaseImagedir*/$.key.imageFileBaseDir = 'img/';/*XmlFile*/$.key.photoDataXml = 'xml/data.xml';$.key.imageCache = new Array();$.key.usa = navigator.userAgent;$.key.isIE = !!(window.attachEvent && !window.opera);$.key.isOpera = Object.prototype.toString.call(window.opera) == '[object Opera]';$.key.isWebKit = (-1 < $.key.usa.indexOf('AppleWebKit/'));$.key.isGecko = (-1 < $.key.usa.indexOf('Gecko') && $.key.usa.indexOf('KHTML') === -1);$.key.isMobileSafari = (/Apple.*Mobile/.test($.key.usa));$.key.log = function(message) {if ( $.key.logFlag && window.console) {console.log(message);}};$.key.getClientHeight = function () {if (document.documentElement && 'clientHeight' in document.documentElement) {return document.documentElement.clientHeight;} else if (document.body && 'clientHeight' in document.body) {return document.body.clientHeight;} else if ('innerHeight' in window) {return window.innerHeight;} else {return 320;}};$.key.getClientWidth = function () {if (document.documentElement && 'clientWidth' in document.documentElement) {return document.documentElement.clientWidth;} else if (document.body && 'clientWidth' in document.body) {return document.body.clientWidth;} else if ('innerWidth' in window) {return window.innerWidth;} else {return 240;}};$.key.getBlankImageSrc = function () {if ($.key.isWebKit) {return 'about:blank';} else {return '';}};$.key.preloadImage = function (uri) {$.key.getImageSrc(uri);};$.key.getImageSrc = function (uri) {var src = null;if (uri in $.key.imageCache) {var img = $.key.imageCache[uri];if (img.isError) {$.key.log('error image (' + uri + ').');src = $.key.getBlankImageSrc();} else if (img.isComplete) {src = img.src;} else {src = img.src;}} else {var img = new Image();img.src = uri;img.isError = false;img.isComplete = false;img.onload = function () {if ($.key.isOpera && !this.complete) {this.isError = true;} else {this.isComplete = true;}};img.onabort = function () {$.key.log('abort image (' + uri + ').');this.isError = true;};img.onerror = function () {$.key.log('error image (' + uri + ').');this.isError = true;};$.key.imageCache[uri] = img;src = uri;}return src;};$.key.initBanner = function(options) {$.ajax({url: $.key.photoDataXml,success:function(data , dataType) {var xml = $(data);var items = new Array();xml.find('picture').each(function (i, item) {var element = $(item);var link = element.find('link').text();var title = element.find('title').text();var target = element.find('target').text();var smallPic = element.find('smallPic').text();var bigPic = element.find('bigPic').text();var timer = element.find('timer').text();items.push( {link: link,title: title,target: target,smallPic: $.key.imageBaseDir + smallPic,bigPic: $.key.imageBaseDir + bigPic,timer: (timer * 1000)});});$(items).each(function (i, item) {$.key.preloadImage(item.smallPic);});$(options).each(function (i, item) {$.key.log('target: '+ i + item);$(item).banner( {items: items } );});},error: function(req, status, thrown) {$.key.log('error:' + status);}});};$.key.log('userAgent: ' + $.key.usa);$.key.log('isOpera: ' + $.key.isOpera);$.key.log('isWebKit: ' + $.key.isWebKit);/*DefineStart*/ $.banner = $.banner || { };/*ScrollInterval*/$.banner.FADE_IN_OUT_INTERVAL = 250;/*ScrollSpeed*/$.banner.SCROLL_SPEED = 500;$.banner.INIT_TIME = 1000;/*Height*/$.banner.HEIGHT = 90;$.banner.PX_HEIGHT = $.banner.HEIGHT + 'px';/*ButtonImageMargin*/$.banner.BUTTON_MARGIN = 5;/*ButtonImageWidth*/$.banner.BUTTON_WIDTH = 21;/*ButtonImageHeight*/$.banner.BUTTON_HEIGHT = 21;$.banner.BUTTON_AVAIL_WIDTH = $.banner.BUTTON_WIDTH + ($.banner.BUTTON_MARGIN * 2);$.banner.PX_BUTTON_MARGIN = $.banner.BUTTON_MARGIN + 'px';$.banner.PX_BUTTON_AVAIL_WIDTH = $.banner.BUTTON_AVAIL_WIDTH + 'px';/*BannerImageW*/$.banner.ITEM_WIDTH = 240;/*BannerImageH*/$.banner.ITEM_HEIGHT = 53;$.banner.ITEM_MARGIN = 5;$.banner.ITEM_AVAIL_WIDTH = $.banner.ITEM_WIDTH + ($.banner.ITEM_MARGIN * 2);$.banner.PX_ITEM_WIDTH = $.banner.ITEM_WIDTH + 'px';$.banner.PX_ITEM_HEIGHT = $.banner.ITEM_HEIGHT + 'px';$.banner.PX_ITEM_MARGIN = $.banner.ITEM_MARGIN + 'px';jQuery.fx.interval = 100;/*defineend*/ $.fn.extend( {src: function (options) {var self = this;self.attr('src',$.key.getImageSrc(options.uri));return self;},banner: function (options) {options = $.extend( { } , $.fn.banner.defaults, options );var items = options.items;var clientWidth = $.key.getClientWidth();var clientWidthPixel = clientWidth + 'px';var self = this;$.key.log('$.key.getClientWidth() = ' + $.key.getClientWidth());self.empty();$.key.log('self ' + self);self.css('position', 'relative');/*self.css('background', 'url(' + $.key.imageFileBaseDir + 'back.gif) repeat-x top');*/self.css('width', clientWidthPixel);self.css('height', $.banner.PX_HEIGHT);self.css('overflow', 'hidden');self.append($('<div>').css('position', 'absolute').css('top',(($.banner.HEIGHT - $.banner.BUTTON_HEIGHT) / 2) + 'px').css('left', $.banner.PX_BUTTON_MARGIN).append($('<a>').click(function() {goNext();}).append($('<img>').src( { uri: $.key.imageFileBaseDir + 'btn_left.gif' } ))));self.append($('<div>').css('position', 'absolute').css('top', (($.banner.HEIGHT - $.banner.BUTTON_HEIGHT) / 2) + 'px' ).css('left',(clientWidth - ($.banner.BUTTON_WIDTH + $.banner.BUTTON_MARGIN)) + 'px').append($('<a>').click(function () {goBack();}).append($('<img>').src( {uri:$.key.imageFileBaseDir + 'btn_right.gif' } ))));if ($.key.isDebug) {self.css('overflow','visible');self.css('width', (clientWidth - 2) + 'px');self.css('border', 'solid green 1px');}$.key.log('banner item count: ' + items.length);var bannerOverviewWidth = (clientWidth - ($.banner.BUTTON_AVAIL_WIDTH * 2));var bannerOverviewWidthPixel = bannerOverviewWidth + 'px';var bannerOverview = $('<div>');bannerOverview.css('position', 'absolute');bannerOverview.css('top', (($.banner.HEIGHT - $.banner.ITEM_HEIGHT) / 2) + 'px');bannerOverview.css('left', $.banner.PX_BUTTON_AVAIL_WIDTH);bannerOverview.css('width', bannerOverviewWidthPixel);bannerOverview.css('height', $.banner.PX_ITEM_HEIGHT);bannerOverview.css('overflow', 'hidden');if ($.key.isDebug) {bannerOverview.css('border', 'solid 1px #333');}var drawItemCount = Math.floor((bannerOverviewWidth / $.banner.ITEM_AVAIL_WIDTH) + 2);$.key.log('drawItemCount: ' + drawItemCount);if ((drawItemCount % 2) == 0) {drawItemCount++;}var bannerContainerWidth = drawItemCount * $.banner.ITEM_AVAIL_WIDTH;var bannerContainerWidthPixel = bannerContainerWidth + 'px';var bannerContainerOffset = 0 - ((bannerContainerWidth - bannerOverviewWidth) / 2);var bannerContainerOffsetPixel = bannerContainerOffset + 'px';var bannerContainer = $('<div>');bannerContainer.css('position', 'relative');bannerContainer.css('left', bannerContainerOffsetPixel);bannerContainer.css('width', bannerContainerWidthPixel);bannerContainer.css('height', $.banner.PX_ITEM_HEIGHT);if ($.key.isDebug) {bannerContainer.css('border', 'solid 1px #ff0000');}for (i = 0; i < drawItemCount; i++) {var bannerItem = $('<div>');bannerItem.addClass('bannerItem');bannerItem.css('display', 'inline');bannerItem.css('margin-left', $.banner.PX_ITEM_MARGIN);bannerItem.css('margin-right', $.banner.PX_ITEM_MARGIN);bannerItem.append($('<a>').append($('<img>').css('width', $.banner.PX_ITEM_WIDTH).css('height', $.banner.PX_ITEM_HEIGHT)));bannerContainer.append(bannerItem);}bannerOverview.append(bannerContainer);self.append(bannerOverview);var activeItemIndex = 0;var beginDrawItemIndex = items.length - Math.floor(((bannerContainerWidth / 2) / $.banner.ITEM_AVAIL_WIDTH));if (items.length <= beginDrawItemIndex) {beginDrawItemIndex = 0;}var mathFloor = Math.floor(((bannerContainerWidth / 2) / $.banner.ITEM_AVAIL_WIDTH));$.key.log('init: ' +'items.length = ' + items.length + 'Math = ' + mathFloor +', ITEM_AVAIL_WIDTH = ' + $.banner.ITEM_AVAIL_WIDTH +'px');var bannerContainerBackToOffset = bannerContainerOffset - $.banner.ITEM_AVAIL_WIDTH;var bannerContainerBackToOffsetPixel = bannerContainerBackToOffset + 'px';var bannerContainerNextToOffset = bannerContainerOffset + $.banner.ITEM_AVAIL_WIDTH;var bannerContainerNextToOffsetPixel = bannerContainerNextToOffset + 'px';$.key.log('init: ' +'clientWidth = ' + clientWidth + 'px, drawItemCount = ' + drawItemCount +', beginDrawItemIndex = ' + beginDrawItemIndex +', bannerContainerWidth = ' + bannerContainerWidth +'px, bannerOverviewWidth = ' + bannerOverviewWidth +'px, bannerContainerOffset = ' + bannerContainerOffset +'px, bannerContainerBackToOffset = ' + bannerContainerBackToOffset +'px');var refreshContainer = function () {var itemIndex = beginDrawItemIndex;$.key.log('activeItemIndex = ' + activeItemIndex + ', beginDrawItemIndex = ' + beginDrawItemIndex +', itemIndex = ' + itemIndex +', title = ' + items[activeItemIndex].title);bannerContainer.find('.bannerItem').each(function (i, bannerItem) {var item = items[itemIndex];var img = $(bannerItem).find('img');var a = $(bannerItem).find('a');a.attr('href', item.link);a.attr('target', item.target);img.attr('alt', item.title);img.attr('title', item.title);img.src( { uri: item.smallPic } );itemIndex++;if (items.length <= itemIndex) {itemIndex -= items.length;}});};var currentTimerId = null;var clearTimer = function () {if (currentTimerId != -1) {clearTimeout(currentTimerId);}currentTimerId = -1;};var cleanUp = function () {clearTimer();$(window).unbind('resize', resize);bannerContainer.clearQueue();self.empty();};var autoTransition = function () {var item = items[activeItemIndex];currentTimerId = setTimeout(function () {goBack();}, item.timer);};var goBack = function () {clearTimer();bannerContainer.stop(true, true).animate( { left: bannerContainerBackToOffsetPixel }, $.banner.SCROLL_SPEED, function () {bannerContainer.css('left', bannerContainerOffsetPixel);if ((items.length - 1) <= activeItemIndex) {activeItemIndex = 0;} else {activeItemIndex++;}if ((items.length - 1) <= beginDrawItemIndex) {beginDrawItemIndex = 0;} else {beginDrawItemIndex++;}refreshContainer();autoTransition();});};var goNext = function () {clearTimer();bannerContainer.stop(true, true).animate( { left: bannerContainerNextToOffsetPixel }, $.banner.SCROLL_SPEED, function () {bannerContainer.css('left', bannerContainerOffsetPixel);if (activeItemIndex <= 0) {activeItemIndex = items.length - 1;} else {activeItemIndex--;}if (beginDrawItemIndex <= 0) {beginDrawItemIndex = items.length - 1;} else {beginDrawItemIndex--;}refreshContainer();autoTransition();});};var resize = function () {$.key.log('resize or orientationchange.');$.key.log('> $.key.getClientWidth() = ' + $.key.getClientWidth());if (clientWidth != $.key.getClientWidth()) {cleanUp();self.banner( { items: options.items } );}};refreshContainer();currentTimerId = setTimeout(function () {goBack();}, $.banner.INIT_TIME);$(window).bind('resize', resize);}} );$.fn.banner.defaults = {};})(jQuery);